# -*- coding: utf-8 -*-

import io
import csv
import logging

from oasislmf.utils.peril import PERILS
from oasislmf.utils.status import OASIS_KEYS_STATUS

KEYS_STATUS_FAIL = OASIS_KEYS_STATUS['fail']['id']
KEYS_STATUS_NOMATCH = OASIS_KEYS_STATUS['nomatch']['id']
KEYS_STATUS_SUCCESS = OASIS_KEYS_STATUS['success']['id']

__all__ = ['VulnerabilityLookup']

class VulnerabilityLookup(object):
    '''
    Functionality to perform a vulnerability lookup.
    '''

    _lookup_data = dict()

    def __init__(self, vulnerabilities_file=None):

        if vulnerabilities_file:
            with io.open(vulnerabilities_file, 'r', encoding='utf-8') as f:
                dr = csv.DictReader(f)
                self.load_lookup_data(dr)

    def load_lookup_data(self, data):
        '''
        Set the lookup data.
        Args:
            data: the lookup data.
        '''
        self._lookup_data = dict(
            (r['taxonomy'], int(r['vulnerability_id']))
            for r in data
        )

    def get_key(self, coverage, class_1):
        '''
        Create the lookup key.
        Args:
        coverage: the coverage
        class_1: the class 1 value
        '''
        #        return '{}-{}'.format(coverage, class_1)
        return '{}-{}'.format(coverage, class_1)

    def do_lookup_location(self, location):
        '''
        Perform a lookup on a specified location.
        Args:
            location: the location to lookup.
        Return:
            Lookup result
        '''
        logging.debug("Looking up location.", )

        # coverage = location['coverage']
        # class_1 = location['class_1']
        # print('VulnerabilityLookup.py: do_lookup_location: {0}'.
        #       format(location))
        key = location['taxonomy']

        status = KEYS_STATUS_NOMATCH
        vulnerability_id = None
        message = ''

        try:
            vulnerability_id = self._lookup_data[key]
            # print('VulnerabilityLookup.py: do_lookup_location: ' +
            #       '{0} -> {1}'.format(key, vulnerability_id))
        except KeyError:
            pass
        else:
            status = KEYS_STATUS_SUCCESS

        return {
            'status': status,
            'vulnerability_id': vulnerability_id,
            'message': None
        }
